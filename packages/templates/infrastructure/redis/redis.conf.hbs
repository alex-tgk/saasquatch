# Redis Configuration for {{project.name}}
# Generated by SaaSQuatch - Enterprise-Grade Tools for Ambitious Startups

# ===================================================================
# Network Configuration
# ===================================================================

# Bind to all interfaces (Docker internal network)
bind 0.0.0.0

# Accept connections on standard Redis port
port 6379

# Enable protected mode for security
protected-mode yes

# TCP listen backlog
tcp-backlog 511

# Close connection after client idle for N seconds (0 to disable)
timeout 300

# TCP keepalive
tcp-keepalive 300

# ===================================================================
# General Configuration
# ===================================================================

# Run as a foreground process (required for Docker)
daemonize no

# Supervised by Docker
supervised no

# PID file location
pidfile /var/run/redis_6379.pid

# Logging level: debug, verbose, notice, warning
loglevel notice

# Log to stdout (Docker will capture logs)
logfile ""

# Number of databases (default: 16)
databases 16

# Show Redis logo on startup
always-show-logo no

# ===================================================================
# Snapshotting (RDB Persistence)
# ===================================================================

# Save the DB to disk:
# save <seconds> <changes>
# Will save the DB if both conditions are met:
# - At least <seconds> seconds passed
# - At least <changes> write operations occurred

save 900 1      # After 900 sec (15 min) if at least 1 key changed
save 300 10     # After 300 sec (5 min) if at least 10 keys changed
save 60 10000   # After 60 sec if at least 10000 keys changed

# Stop accepting writes if RDB save fails
stop-writes-on-bgsave-error yes

# Compress string objects in RDB dumps
rdbcompression yes

# Checksum RDB files
rdbchecksum yes

# RDB filename
dbfilename dump.rdb

# Working directory for RDB files
dir /data

# ===================================================================
# Append Only File (AOF Persistence)
# ===================================================================

# Enable AOF persistence
appendonly yes

# AOF filename
appendfilename "appendonly.aof"

# fsync() policy:
# - no: don't fsync, just let OS flush data (fastest)
# - always: fsync after every write (slowest, safest)
# - everysec: fsync once per second (good compromise)
appendfsync everysec

# Don't use fsync while rewriting AOF
no-appendfsync-on-rewrite no

# Automatically rewrite AOF when it grows by percentage
auto-aof-rewrite-percentage 100

# Minimum AOF file size to trigger rewrite
auto-aof-rewrite-min-size 64mb

# Load truncated AOF files
aof-load-truncated yes

# Use RDB-AOF hybrid format for faster restarts
aof-use-rdb-preamble yes

# ===================================================================
# Memory Management
# ===================================================================

# Maximum memory limit (256MB default, adjust based on needs)
maxmemory 256mb

# Eviction policy when maxmemory is reached:
# - volatile-lru: Remove keys with TTL using LRU
# - allkeys-lru: Remove any key using LRU (recommended for cache)
# - volatile-lfu: Remove keys with TTL using LFU
# - allkeys-lfu: Remove any key using LFU
# - volatile-random: Remove random keys with TTL
# - allkeys-random: Remove random keys
# - volatile-ttl: Remove keys with soonest TTL
# - noeviction: Return errors when memory limit is reached
maxmemory-policy allkeys-lru

# LRU/LFU sample size (higher = more accurate, slower)
maxmemory-samples 5

# ===================================================================
# Lazy Freeing
# ===================================================================

# Perform memory deallocation in background threads
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# Delete objects in background after UNLINK command
lazyfree-lazy-user-del no

# ===================================================================
# Replication (For Master-Slave Setup)
# ===================================================================

# Uncomment to configure as replica:
# replicaof <masterip> <masterport>

# Authenticate with master if password is set:
# masterauth <master-password>

# Serve read queries when disconnected from master
replica-serve-stale-data yes

# Read-only replica
replica-read-only yes

# Disable TCP_NODELAY on replica socket
repl-disable-tcp-nodelay no

# Replica priority (lower = higher priority for promotion)
replica-priority 100

# ===================================================================
# Security
# ===================================================================

# Require password for connections (leave empty for no password)
# In Docker, set via command line for better security
# requirepass your-strong-password-here

# Rename dangerous commands (optional)
# rename-command FLUSHDB ""
# rename-command FLUSHALL ""
# rename-command CONFIG ""

# Disable certain commands
# rename-command DEBUG ""

# ===================================================================
# Clients Management
# ===================================================================

# Maximum number of connected clients
maxclients 10000

# ===================================================================
# Slow Log
# ===================================================================

# Log queries slower than N microseconds (10ms default)
slowlog-log-slower-than 10000

# Maximum slow log entries to keep
slowlog-max-len 128

# ===================================================================
# Latency Monitor
# ===================================================================

# Latency monitoring threshold in milliseconds
# 0 disables latency monitoring
latency-monitor-threshold 100

# ===================================================================
# Event Notification
# ===================================================================

# Enable keyspace notifications
# K - Keyspace events
# E - Keyevent events
# g - Generic commands (DEL, EXPIRE, etc)
# $ - String commands
# l - List commands
# s - Set commands
# h - Hash commands
# z - Sorted set commands
# x - Expired events
# e - Evicted events
# A - Alias for "g$lshzxe"

# Example: notify-keyspace-events "Ex"
notify-keyspace-events ""

# ===================================================================
# Advanced Configuration
# ===================================================================

# Hash max entries before conversion to hash table
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# List max entries before conversion to linked list
list-max-ziplist-size -2
list-compress-depth 0

# Set max entries before conversion to hash table
set-max-intset-entries 512

# Sorted set max entries before conversion to skiplist
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog sparse representation limit
hll-sparse-max-bytes 3000

# Streams macro node max size
stream-node-max-bytes 4096
stream-node-max-entries 100

# Active rehashing
activerehashing yes

# Client output buffer limits
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# Frequency of background tasks
hz 10

# Enable dynamic hz adjustment
dynamic-hz yes

# AOF rewrite incremental fsync
aof-rewrite-incremental-fsync yes

# RDB save incremental fsync
rdb-save-incremental-fsync yes

# ===================================================================
# Active Defragmentation
# ===================================================================

# Enable active defragmentation
activedefrag no

# Minimum percentage of fragmentation to start defrag
# active-defrag-ignore-bytes 100mb
# active-defrag-threshold-lower 10

# Maximum percentage of fragmentation to force defrag
# active-defrag-threshold-upper 100

# Minimal CPU effort for defrag
# active-defrag-cycle-min 1

# Maximal CPU effort for defrag
# active-defrag-cycle-max 25

# Maximum number of keys to process per cycle
# active-defrag-max-scan-fields 1000

# ===================================================================
# TLS/SSL Configuration (Optional)
# ===================================================================

# Uncomment and configure for TLS connections:
# port 0
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt

# ===================================================================
# Lua Scripting
# ===================================================================

# Maximum execution time for Lua scripts (ms)
lua-time-limit 5000

# ===================================================================
# Redis Cluster Configuration
# ===================================================================

# Uncomment to enable cluster mode:
# cluster-enabled yes
# cluster-config-file nodes-6379.conf
# cluster-node-timeout 15000

# ===================================================================
# End of Configuration
# ===================================================================
