-- PostgreSQL initialization script for multi-tenant support
-- This runs when the PostgreSQL container first starts

-- Create extension for UUID generation
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- Create function to create tenant schemas dynamically
CREATE OR REPLACE FUNCTION create_tenant_schema(tenant_id TEXT)
RETURNS VOID AS $$
BEGIN
  -- Create schema
  EXECUTE format('CREATE SCHEMA IF NOT EXISTS tenant_%s', tenant_id);

  -- Create users table in tenant schema
  EXECUTE format('
    CREATE TABLE IF NOT EXISTS tenant_%s.users (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      email VARCHAR(255) UNIQUE NOT NULL,
      name VARCHAR(255) NOT NULL,
      avatar_url VARCHAR(500),
      metadata JSONB DEFAULT ''{}''::jsonb,
      created_at TIMESTAMP DEFAULT NOW(),
      updated_at TIMESTAMP DEFAULT NOW()
    )', tenant_id);

  -- Create indexes
  EXECUTE format('
    CREATE INDEX IF NOT EXISTS idx_users_email
    ON tenant_%s.users(email)
  ', tenant_id);

  EXECUTE format('
    CREATE INDEX IF NOT EXISTS idx_users_created_at
    ON tenant_%s.users(created_at DESC)
  ', tenant_id);

  -- Create updated_at trigger function
  EXECUTE format('
    CREATE OR REPLACE FUNCTION tenant_%s.update_updated_at_column()
    RETURNS TRIGGER AS $func$
    BEGIN
      NEW.updated_at = NOW();
      RETURN NEW;
    END;
    $func$ language ''plpgsql''
  ', tenant_id);

  -- Create trigger
  EXECUTE format('
    CREATE TRIGGER update_users_updated_at
    BEFORE UPDATE ON tenant_%s.users
    FOR EACH ROW
    EXECUTE FUNCTION tenant_%s.update_updated_at_column()
  ', tenant_id, tenant_id);

  RAISE NOTICE 'Created tenant schema: tenant_%', tenant_id;
END;
$$ LANGUAGE plpgsql;

-- Create public schema tables for cross-tenant data if needed
-- (e.g., tenant registry, feature flags, etc.)

CREATE TABLE IF NOT EXISTS public.tenant_registry (
  tenant_id TEXT PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  status VARCHAR(50) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_tenant_registry_status
ON public.tenant_registry(status);

-- Create admin user table (not tenant-specific)
CREATE TABLE IF NOT EXISTS public.admin_users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(50) DEFAULT 'admin',
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
