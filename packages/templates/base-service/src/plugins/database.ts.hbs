import fp from 'fastify-plugin';
import knex, { Knex } from 'knex';

declare module 'fastify' {
  interface FastifyInstance {
    db: Knex;
  }
}

async function databasePlugin(fastify: any) {
  const config: Knex.Config = {
    client: '{{infrastructure.database.type}}',
    connection: {{#if (eq infrastructure.database.type "postgresql")}}process.env.DATABASE_URL || {
      host: process.env.DB_HOST || 'localhost',
      port: parseInt(process.env.DB_PORT || '5432', 10),
      user: process.env.DB_USER || 'postgres',
      password: process.env.DB_PASSWORD || 'postgres',
      database: process.env.DB_NAME || '{{snakeCase service.name}}',
    }{{else}}process.env.DATABASE_URL || './data/{{service.name}}.db'{{/if}},{{#if (eq infrastructure.database.type "sqlite")}}
    useNullAsDefault: true,{{/if}}
    pool: {
      min: 2,
      max: 10,
    },
    migrations: {
      directory: './migrations',
    },
  };
{{#if (eq infrastructure.database.type "postgresql")}}

  // Validate database credentials for production readiness
  if (process.env.NODE_ENV === 'production') {
    const dbUser = process.env.DB_USER || 'postgres';
    const dbPassword = process.env.DB_PASSWORD || 'postgres';

    if (dbUser === 'postgres' && dbPassword === 'postgres') {
      throw new Error(
        'ðŸ”’ SECURITY ERROR: Default PostgreSQL credentials detected in production. ' +
        'Using "postgres/postgres" is NOT SAFE FOR PRODUCTION. ' +
        'Please set DB_USER and DB_PASSWORD environment variables to secure values.'
      );
    }

    if (!process.env.DATABASE_URL && dbPassword === 'postgres') {
      throw new Error(
        'ðŸ”’ SECURITY ERROR: Default PostgreSQL password detected in production. ' +
        'Please set DB_PASSWORD environment variable to a secure value.'
      );
    }
  } else if (!process.env.DATABASE_URL) {
    // Development mode warning
    const dbUser = process.env.DB_USER || 'postgres';
    const dbPassword = process.env.DB_PASSWORD || 'postgres';

    if (dbUser === 'postgres' && dbPassword === 'postgres') {
      fastify.log.warn({
        msg: 'âš ï¸  WARNING: Using default PostgreSQL credentials (postgres/postgres)',
        recommendation: 'Set DB_USER and DB_PASSWORD environment variables for better security',
        note: 'This is acceptable for development but REQUIRED to change for production',
      });
    }
  }
{{/if}}

  const db = knex(config);

  // Test connection
  try {
    await db.raw('SELECT 1');
    fastify.log.info('Database connected successfully');
  } catch (error) {
    fastify.log.error('Database connection failed:', error);
    throw error;
  }

  fastify.decorate('db', db);

  fastify.addHook('onClose', async () => {
    await db.destroy();
  });
}

export default fp(databasePlugin, {
  name: 'database',
});

export { databasePlugin };
