import { FastifyPluginAsync } from 'fastify';

export const healthRoutes: FastifyPluginAsync = async (fastify) => {
  fastify.get('/health', async (request, reply) => {
    return {
      status: 'healthy',
      service: '{{service.name}}',
      timestamp: new Date().toISOString(),
    };
  });

  fastify.get('/ready', async (request, reply) => {
    const checks: Record<string, boolean> = {};

    {{#if service.features.database}}// Check database
    try {
      await fastify.db.raw('SELECT 1');
      checks.database = true;
    } catch (error) {
      checks.database = false;
    }

    {{/if}}{{#if service.features.cache}}// Check Redis
    try {
      await fastify.redis.ping();
      checks.redis = true;
    } catch (error) {
      checks.redis = false;
    }

    {{/if}}{{#if service.features.messageQueue}}// Check NATS
    try {
      checks.nats = fastify.nats.isClosed() === false;
    } catch (error) {
      checks.nats = false;
    }

    {{/if}}const allHealthy = Object.values(checks).every(v => v === true);
    const status = allHealthy ? 'ready' : 'not ready';

    reply.code(allHealthy ? 200 : 503);
    return {
      status,
      checks,
      service: '{{service.name}}',
      timestamp: new Date().toISOString(),
    };
  });
};
