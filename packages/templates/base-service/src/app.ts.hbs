import Fastify from 'fastify';
import { TypeBoxTypeProvider } from '@fastify/type-provider-typebox';
import swagger from '@fastify/swagger';
import swaggerUi from '@fastify/swagger-ui';
import { swaggerOptions, swaggerUiOptions } from './config/swagger.config.js';
{{#if service.features.cors}}import cors from '@fastify/cors';
{{/if}}{{#if service.features.rateLimit}}import rateLimit from '@fastify/rate-limit';
{{/if}}{{#if service.features.compression}}import compress from '@fastify/compress';
{{/if}}import metricsPlugin from './plugins/metrics.js';
{{#if service.features.healthChecks}}import { healthRoutes } from './routes/health.js';
{{/if}}{{#if (or service.features.authentication service.features.jwt)}}import { authRoutes } from './routes/auth.js';
{{/if}}{{#if service.features.database}}import { databasePlugin } from './plugins/database.js';
{{/if}}{{#if service.features.cache}}import { redisPlugin } from './plugins/redis.js';
{{/if}}{{#if service.features.messageQueue}}import { natsPlugin } from './plugins/nats.js';
{{/if}}{{#if service.features.jwt}}import { authPlugin } from './plugins/auth.js';
{{/if}}

export async function buildApp(opts = {}) {
  const app = Fastify({
    logger: {
      level: process.env.LOG_LEVEL || 'info',
      ...(process.env.NODE_ENV === 'development' && {
        transport: {
          target: 'pino-pretty',
          options: {
            translateTime: 'HH:MM:ss Z',
            ignore: 'pid,hostname',
          },
        },
      }),
    },
    ...opts,
  }).withTypeProvider<TypeBoxTypeProvider>();

  // Register Swagger for API documentation
  await app.register(swagger, swaggerOptions);
  await app.register(swaggerUi, swaggerUiOptions);

  // Register plugins
  {{#if service.features.cors}}await app.register(cors, {
    origin: process.env.CORS_ORIGIN || true,
    credentials: true,
  });

  {{/if}}{{#if service.features.rateLimit}}await app.register(rateLimit, {
    max: 100,
    timeWindow: '1 minute',
  });

  {{/if}}{{#if service.features.compression}}await app.register(compress);

  {{/if}}// Register metrics plugin (Prometheus + JSON endpoints)
  await app.register(metricsPlugin);

  {{#if service.features.database}}await app.register(databasePlugin);
  {{/if}}{{#if service.features.cache}}await app.register(redisPlugin);
  {{/if}}{{#if service.features.messageQueue}}await app.register(natsPlugin);
  {{/if}}{{#if service.features.jwt}}await app.register(authPlugin);

  {{/if}}// Register routes
  {{#if service.features.healthChecks}}await app.register(healthRoutes);
  {{/if}}{{#if (or service.features.authentication service.features.jwt)}}await app.register(authRoutes);

  {{/if}}// Service discovery endpoint for dynamic port discovery
  app.get('/discovery', async (request, reply) => {
    const address = app.server.address();
    const port = address && typeof address !== 'string' ? address.port : {{service.port}};
    const host = process.env.HOST || 'localhost';

    return {
      name: '{{service.name}}',
      port,
      host,
      url: `http://${host}:${port}`,
      features: {
        database: {{#if service.features.database}}true{{else}}false{{/if}},
        cache: {{#if service.features.cache}}true{{else}}false{{/if}},
        messageQueue: {{#if service.features.messageQueue}}true{{else}}false{{/if}},
        authentication: {{#if service.features.authentication}}true{{else}}false{{/if}},
      },
    };
  });

  // Default route
  app.get('/', {
    schema: {
      description: 'Service information endpoint',
      tags: ['General'],
      response: {
        200: {
          type: 'object',
          properties: {
            service: { type: 'string', example: '{{service.name}}' },
            version: { type: 'string', example: '0.1.0' },
            status: { type: 'string', example: 'running' },
            documentation: { type: 'string', example: 'http://localhost:{{service.port}}/docs' },
          },
        },
      },
    },
  }, async (request, reply) => {
    return {
      service: '{{service.name}}',
      version: '0.1.0',
      status: 'running',
      documentation: `http://localhost:{{service.port}}/docs`,
    };
  });

  return app;
}
