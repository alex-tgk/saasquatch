'use client'

import { useState, useEffect, useRef } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Input } from '@/components/ui/input'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Search, RefreshCw, Download, Trash2 } from 'lucide-react'
import { formatTimestamp } from '@/lib/utils'
import type { LogEntry } from '@/lib/types'

interface LogsViewerProps {
  serviceName?: string
  maxLogs?: number
}

export function LogsViewer({ serviceName, maxLogs = 1000 }: LogsViewerProps) {
  const [logs, setLogs] = useState<LogEntry[]>([])
  const [filter, setFilter] = useState('')
  const [levelFilter, setLevelFilter] = useState<string>('all')
  const [autoScroll, setAutoScroll] = useState(true)
  const logsEndRef = useRef<HTMLDivElement>(null)

  useEffect(() => {
    if (autoScroll) {
      logsEndRef.current?.scrollIntoView({ behavior: 'smooth' })
    }
  }, [logs, autoScroll])

  const filteredLogs = logs.filter((log) => {
    const matchesFilter = filter === '' ||
      log.message.toLowerCase().includes(filter.toLowerCase()) ||
      JSON.stringify(log.context).toLowerCase().includes(filter.toLowerCase())

    const matchesLevel = levelFilter === 'all' || log.level === levelFilter

    const matchesService = !serviceName || log.service === serviceName

    return matchesFilter && matchesLevel && matchesService
  })

  const getLevelBadge = (level: string) => {
    const variants = {
      debug: 'default',
      info: 'secondary',
      warn: 'warning',
      error: 'error',
      fatal: 'error',
    } as const

    return (
      <Badge variant={variants[level as keyof typeof variants] || 'default'} className="font-mono text-xs">
        {level.toUpperCase()}
      </Badge>
    )
  }

  const clearLogs = () => {
    setLogs([])
  }

  const downloadLogs = () => {
    const data = JSON.stringify(filteredLogs, null, 2)
    const blob = new Blob([data], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = `logs-${serviceName || 'all'}-${new Date().toISOString()}.json`
    a.click()
    URL.revokeObjectURL(url)
  }

  return (
    <Card className="h-full flex flex-col">
      <CardHeader>
        <div className="flex items-center justify-between">
          <div>
            <CardTitle>Service Logs</CardTitle>
            <CardDescription>
              {serviceName ? `Viewing logs for ${serviceName}` : 'Viewing all service logs'}
            </CardDescription>
          </div>
          <div className="flex gap-2">
            <Button size="sm" variant="outline" onClick={downloadLogs}>
              <Download className="h-4 w-4" />
            </Button>
            <Button size="sm" variant="outline" onClick={clearLogs}>
              <Trash2 className="h-4 w-4" />
            </Button>
            <Button size="sm" variant="outline" onClick={() => setAutoScroll(!autoScroll)}>
              <RefreshCw className={`h-4 w-4 ${autoScroll ? 'animate-pulse' : ''}`} />
            </Button>
          </div>
        </div>
      </CardHeader>
      <CardContent className="flex-1 flex flex-col space-y-4">
        {/* Filters */}
        <div className="flex gap-2">
          <div className="relative flex-1">
            <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search logs..."
              value={filter}
              onChange={(e) => setFilter(e.target.value)}
              className="pl-8"
            />
          </div>
          <select
            value={levelFilter}
            onChange={(e) => setLevelFilter(e.target.value)}
            className="rounded-md border border-input bg-background px-3 py-2 text-sm"
          >
            <option value="all">All Levels</option>
            <option value="debug">Debug</option>
            <option value="info">Info</option>
            <option value="warn">Warn</option>
            <option value="error">Error</option>
            <option value="fatal">Fatal</option>
          </select>
        </div>

        {/* Logs Display */}
        <div className="flex-1 overflow-auto rounded-md border bg-muted/10 p-4 font-mono text-sm">
          {filteredLogs.length === 0 ? (
            <div className="flex h-full items-center justify-center text-muted-foreground">
              No logs to display
            </div>
          ) : (
            <div className="space-y-2">
              {filteredLogs.map((log, index) => (
                <div
                  key={index}
                  className={`rounded p-2 ${
                    log.level === 'error' || log.level === 'fatal'
                      ? 'bg-red-50 dark:bg-red-950/20'
                      : log.level === 'warn'
                      ? 'bg-yellow-50 dark:bg-yellow-950/20'
                      : 'bg-background'
                  }`}
                >
                  <div className="flex items-start gap-2">
                    <span className="text-xs text-muted-foreground whitespace-nowrap">
                      {formatTimestamp(log.timestamp)}
                    </span>
                    {getLevelBadge(log.level)}
                    <span className="text-xs text-primary font-semibold">[{log.service}]</span>
                    <span className="flex-1">{log.message}</span>
                  </div>
                  {log.context && Object.keys(log.context).length > 0 && (
                    <pre className="mt-1 text-xs text-muted-foreground overflow-x-auto">
                      {JSON.stringify(log.context, null, 2)}
                    </pre>
                  )}
                  {log.error && (
                    <div className="mt-1 rounded bg-red-100 dark:bg-red-950/40 p-2">
                      <p className="text-xs font-semibold text-red-800 dark:text-red-200">
                        {log.error.message}
                      </p>
                      {log.error.stack && (
                        <pre className="mt-1 text-xs text-red-700 dark:text-red-300 overflow-x-auto">
                          {log.error.stack}
                        </pre>
                      )}
                    </div>
                  )}
                </div>
              ))}
              <div ref={logsEndRef} />
            </div>
          )}
        </div>

        {/* Stats */}
        <div className="flex justify-between text-xs text-muted-foreground">
          <span>
            Showing {filteredLogs.length} of {logs.length} logs
          </span>
          <span>Max: {maxLogs} logs</span>
        </div>
      </CardContent>
    </Card>
  )
}
