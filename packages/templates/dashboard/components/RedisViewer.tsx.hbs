'use client'

import { useState } from 'react'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { Badge } from '@/components/ui/badge'
import { Button } from '@/components/ui/button'
import { Input } from '@/components/ui/input'
import { Separator } from '@/components/ui/separator'
import { Database, Search, Trash2, RefreshCw, Clock } from 'lucide-react'
import { formatBytes } from '@/lib/utils'
import type { RedisKey, RedisValue } from '@/lib/types'

interface RedisViewerProps {
  keys: RedisKey[]
  onRefresh?: () => void
  onDelete?: (key: string) => void
  onViewValue?: (key: string) => void
}

export function RedisViewer({ keys, onRefresh, onDelete, onViewValue }: RedisViewerProps) {
  const [search, setSearch] = useState('')
  const [selectedKey, setSelectedKey] = useState<RedisKey | null>(null)

  const filteredKeys = keys.filter((key) =>
    key.key.toLowerCase().includes(search.toLowerCase())
  )

  const getTypeColor = (type: string) => {
    const colors = {
      string: 'default',
      hash: 'secondary',
      list: 'success',
      set: 'warning',
      zset: 'error',
    } as const
    return colors[type as keyof typeof colors] || 'default'
  }

  const formatTTL = (ttl: number) => {
    if (ttl === -1) return 'No expiry'
    if (ttl === -2) return 'Expired'

    const hours = Math.floor(ttl / 3600)
    const minutes = Math.floor((ttl % 3600) / 60)
    const seconds = ttl % 60

    if (hours > 0) return `${hours}h ${minutes}m`
    if (minutes > 0) return `${minutes}m ${seconds}s`
    return `${seconds}s`
  }

  return (
    <div className="grid gap-4 md:grid-cols-2">
      {/* Keys List */}
      <Card className="h-full">
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle className="flex items-center gap-2">
                <Database className="h-5 w-5" />
                Redis Keys
              </CardTitle>
              <CardDescription>{keys.length} keys total</CardDescription>
            </div>
            <Button size="sm" variant="outline" onClick={onRefresh}>
              <RefreshCw className="h-4 w-4" />
            </Button>
          </div>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Search */}
          <div className="relative">
            <Search className="absolute left-2 top-2.5 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search keys..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
              className="pl-8"
            />
          </div>

          {/* Keys */}
          <div className="max-h-[500px] space-y-2 overflow-auto">
            {filteredKeys.length === 0 ? (
              <div className="flex h-48 items-center justify-center text-muted-foreground">
                No keys found
              </div>
            ) : (
              filteredKeys.map((key) => (
                <Card
                  key={key.key}
                  className={`cursor-pointer transition-all ${
                    selectedKey?.key === key.key ? 'ring-2 ring-primary' : ''
                  }`}
                  onClick={() => setSelectedKey(key)}
                >
                  <CardContent className="p-3">
                    <div className="space-y-2">
                      <div className="flex items-start justify-between gap-2">
                        <span className="font-mono text-sm font-medium break-all">
                          {key.key}
                        </span>
                        <Badge variant={getTypeColor(key.type)} className="text-xs">
                          {key.type}
                        </Badge>
                      </div>
                      <div className="flex items-center justify-between text-xs text-muted-foreground">
                        <div className="flex items-center gap-1">
                          <Clock className="h-3 w-3" />
                          {formatTTL(key.ttl)}
                        </div>
                        <span>{formatBytes(key.size)}</span>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              ))
            )}
          </div>
        </CardContent>
      </Card>

      {/* Key Details */}
      <Card className="h-full">
        <CardHeader>
          <CardTitle>Key Details</CardTitle>
          <CardDescription>
            {selectedKey ? `Viewing: ${selectedKey.key}` : 'Select a key to view details'}
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          {selectedKey ? (
            <>
              <div className="space-y-3">
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Key:</span>
                  <span className="font-mono font-medium break-all">{selectedKey.key}</span>
                </div>
                <Separator />
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Type:</span>
                  <Badge variant={getTypeColor(selectedKey.type)}>{selectedKey.type}</Badge>
                </div>
                <Separator />
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">TTL:</span>
                  <span className="font-medium">{formatTTL(selectedKey.ttl)}</span>
                </div>
                <Separator />
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Size:</span>
                  <span className="font-medium">{formatBytes(selectedKey.size)}</span>
                </div>
              </div>

              {/* Actions */}
              <div className="flex gap-2 pt-4">
                <Button
                  size="sm"
                  variant="outline"
                  className="flex-1"
                  onClick={() => onViewValue?.(selectedKey.key)}
                >
                  View Value
                </Button>
                <Button
                  size="sm"
                  variant="destructive"
                  onClick={() => {
                    onDelete?.(selectedKey.key)
                    setSelectedKey(null)
                  }}
                >
                  <Trash2 className="h-4 w-4" />
                </Button>
              </div>
            </>
          ) : (
            <div className="flex h-48 items-center justify-center text-muted-foreground">
              Select a key to view details
            </div>
          )}
        </CardContent>
      </Card>
    </div>
  )
}
