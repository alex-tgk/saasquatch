'use client'

import { LineChart, Line, AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, Legend } from 'recharts'
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card'
import { formatBytes } from '@/lib/utils'

interface MetricsDataPoint {
  timestamp: string
  cpu: number
  memory: number
  requests: number
  errors: number
  latency: number
}

interface MetricsChartProps {
  title: string
  description?: string
  data: MetricsDataPoint[]
  metrics: ('cpu' | 'memory' | 'requests' | 'errors' | 'latency')[]
  chartType?: 'line' | 'area'
}

export function MetricsChart({
  title,
  description,
  data,
  metrics,
  chartType = 'line'
}: MetricsChartProps) {
  const getMetricColor = (metric: string) => {
    const colors = {
      cpu: '#3b82f6',      // blue
      memory: '#10b981',   // green
      requests: '#8b5cf6', // purple
      errors: '#ef4444',   // red
      latency: '#f59e0b',  // orange
    }
    return colors[metric as keyof typeof colors] || '#6b7280'
  }

  const formatYAxis = (value: number, metric?: string) => {
    if (metric === 'memory') {
      return formatBytes(value)
    }
    if (metric === 'cpu' || metric === 'percentage') {
      return `${value}%`
    }
    if (metric === 'latency') {
      return `${value}ms`
    }
    return value.toString()
  }

  const CustomTooltip = ({ active, payload, label }: any) => {
    if (active && payload && payload.length) {
      return (
        <div className="rounded-lg border bg-background p-3 shadow-md">
          <p className="text-sm font-medium">{new Date(label).toLocaleTimeString()}</p>
          <div className="mt-2 space-y-1">
            {payload.map((entry: any, index: number) => (
              <div key={index} className="flex items-center gap-2 text-xs">
                <div
                  className="h-2 w-2 rounded-full"
                  style={{ backgroundColor: entry.color }}
                />
                <span className="capitalize">{entry.name}:</span>
                <span className="font-medium">
                  {entry.name === 'memory'
                    ? formatBytes(entry.value)
                    : entry.name === 'cpu'
                    ? `${entry.value}%`
                    : entry.name === 'latency'
                    ? `${entry.value}ms`
                    : entry.value
                  }
                </span>
              </div>
            ))}
          </div>
        </div>
      )
    }
    return null
  }

  const ChartComponent = chartType === 'area' ? AreaChart : LineChart
  const DataComponent = chartType === 'area' ? Area : Line

  return (
    <Card>
      <CardHeader>
        <CardTitle>{title}</CardTitle>
        {description && <CardDescription>{description}</CardDescription>}
      </CardHeader>
      <CardContent>
        <div className="h-[300px]">
          <ResponsiveContainer width="100%" height="100%">
            <ChartComponent data={data}>
              <CartesianGrid strokeDasharray="3 3" className="stroke-muted" />
              <XAxis
                dataKey="timestamp"
                tickFormatter={(value) => new Date(value).toLocaleTimeString()}
                className="text-xs"
              />
              <YAxis
                className="text-xs"
                tickFormatter={(value) => formatYAxis(value)}
              />
              <Tooltip content={<CustomTooltip />} />
              <Legend />
              {metrics.map((metric) => (
                <DataComponent
                  key={metric}
                  type="monotone"
                  dataKey={metric}
                  stroke={getMetricColor(metric)}
                  fill={getMetricColor(metric)}
                  fillOpacity={chartType === 'area' ? 0.3 : 1}
                  strokeWidth={2}
                  name={metric.charAt(0).toUpperCase() + metric.slice(1)}
                />
              ))}
            </ChartComponent>
          </ResponsiveContainer>
        </div>
      </CardContent>
    </Card>
  )
}
