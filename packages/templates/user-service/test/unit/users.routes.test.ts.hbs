import { describe, it, expect, beforeEach, afterEach, beforeAll, afterAll, jest } from '@jest/globals';
import { buildApp } from '../../src/app.js';
import Knex from 'knex';
import type { FastifyInstance } from 'fastify';

/**
 * Integration tests for user routes
 *
 * These tests verify the complete request/response cycle including:
 * - Route handlers
 * - Authentication middleware
 * - Repository operations
 * - Multi-tenancy
 * - JSON Schema validation
 */
describe('User Routes', () => {
  let app: FastifyInstance;
  let db: Knex.Knex;
  const testTenantId = 'test-tenant-789';
  const testTenantSchema = `tenant_${testTenantId}`;
  let authToken: string;

  // Mock auth service
  const mockAuthServiceUrl = 'http://localhost:9999';

  beforeAll(async () => {
    // Setup test database
    db = Knex({
      client: 'pg',
      connection: {
        host: process.env.DB_HOST || 'localhost',
        port: parseInt(process.env.DB_PORT || '5432'),
        user: process.env.DB_USER || 'postgres',
        password: process.env.DB_PASSWORD || 'postgres',
        database: process.env.DB_NAME || 'test_db',
      },
    });

    // Mock fetch for auth service verification
    global.fetch = jest.fn((url: string, options?: any) => {
      if (url.includes('/auth/verify')) {
        const body = JSON.parse(options?.body || '{}');
        if (body.token === 'valid-token') {
          return Promise.resolve({
            ok: true,
            json: () => Promise.resolve({
              userId: 'test-user-id',
              email: 'test@example.com',
              tenantId: testTenantId,
            }),
          } as Response);
        }
        return Promise.resolve({
          ok: false,
          json: () => Promise.resolve({ error: 'Invalid token' }),
        } as Response);
      }
      return Promise.reject(new Error('Unknown endpoint'));
    }) as any;

    // Set auth token for tests
    authToken = 'valid-token';

    // Set auth service URL
    process.env.AUTH_SERVICE_URL = mockAuthServiceUrl;
  });

  afterAll(async () => {
    await db.destroy();
  });

  beforeEach(async () => {
    // Create tenant schema and tables
    await db.raw(`CREATE SCHEMA IF NOT EXISTS ${testTenantSchema}`);
    await db.raw(`SET search_path TO ${testTenantSchema}`);
    await db.raw(`
      CREATE TABLE IF NOT EXISTS users (
        id UUID PRIMARY KEY,
        email VARCHAR(255) UNIQUE NOT NULL,
        name VARCHAR(255) NOT NULL,
        avatar_url VARCHAR(500),
        metadata JSONB DEFAULT '{}'::jsonb,
        created_at TIMESTAMP DEFAULT NOW(),
        updated_at TIMESTAMP DEFAULT NOW(),
        deleted_at TIMESTAMP
      )
    `);

    // Build Fastify app
    app = await buildApp({ logger: false });
    await app.ready();
  });

  afterEach(async () => {
    await app.close();
    await db.raw(`DROP SCHEMA IF EXISTS ${testTenantSchema} CASCADE`);
  });

  describe('POST /users', () => {
    it('should create a new user', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          email: 'newuser@example.com',
          name: 'New User',
        },
      });

      expect(response.statusCode).toBe(201);
      const body = JSON.parse(response.body);
      expect(body.id).toBeDefined();
      expect(body.email).toBe('newuser@example.com');
      expect(body.name).toBe('New User');
      expect(body.avatarUrl).toBeNull();
      expect(body.createdAt).toBeDefined();
      expect(body.updatedAt).toBeDefined();
    });

    it('should create user with avatar URL', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          email: 'avatar@example.com',
          name: 'Avatar User',
          avatarUrl: 'https://example.com/avatar.jpg',
        },
      });

      expect(response.statusCode).toBe(201);
      const body = JSON.parse(response.body);
      expect(body.avatarUrl).toBe('https://example.com/avatar.jpg');
    });

    it('should return 409 when email already exists', async () => {
      await app.inject({
        method: 'POST',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          email: 'duplicate@example.com',
          name: 'First User',
        },
      });

      const response = await app.inject({
        method: 'POST',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          email: 'duplicate@example.com',
          name: 'Second User',
        },
      });

      expect(response.statusCode).toBe(409);
      const body = JSON.parse(response.body);
      expect(body.error).toContain('already exists');
    });

    it('should return 400 when email is missing', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          name: 'No Email User',
        },
      });

      expect(response.statusCode).toBe(400);
    });

    it('should return 400 when email is invalid', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          email: 'not-an-email',
          name: 'Invalid Email User',
        },
      });

      expect(response.statusCode).toBe(400);
    });

    it('should return 401 when token is missing', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/users',
        payload: {
          email: 'test@example.com',
          name: 'Test User',
        },
      });

      expect(response.statusCode).toBe(401);
    });

    it('should return 401 when token is invalid', async () => {
      const response = await app.inject({
        method: 'POST',
        url: '/users',
        headers: {
          authorization: 'Bearer invalid-token',
        },
        payload: {
          email: 'test@example.com',
          name: 'Test User',
        },
      });

      expect(response.statusCode).toBe(401);
    });
  });

  describe('GET /users', () => {
    it('should list all users', async () => {
      // Create some test users
      await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'user1@example.com', name: 'User 1' },
      });
      await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'user2@example.com', name: 'User 2' },
      });

      const response = await app.inject({
        method: 'GET',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.data).toHaveLength(2);
      expect(body.pagination).toBeDefined();
      expect(body.pagination.total).toBe(2);
      expect(body.pagination.limit).toBe(10);
      expect(body.pagination.offset).toBe(0);
    });

    it('should support pagination with limit', async () => {
      // Create 3 users
      for (let i = 1; i <= 3; i++) {
        await app.inject({
          method: 'POST',
          url: '/users',
          headers: { authorization: `Bearer ${authToken}` },
          payload: { email: `user${i}@example.com`, name: `User ${i}` },
        });
      }

      const response = await app.inject({
        method: 'GET',
        url: '/users?limit=2',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.data).toHaveLength(2);
      expect(body.pagination.total).toBe(3);
    });

    it('should support pagination with offset', async () => {
      // Create 3 users
      for (let i = 1; i <= 3; i++) {
        await app.inject({
          method: 'POST',
          url: '/users',
          headers: { authorization: `Bearer ${authToken}` },
          payload: { email: `user${i}@example.com`, name: `User ${i}` },
        });
      }

      const response = await app.inject({
        method: 'GET',
        url: '/users?offset=2',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.data).toHaveLength(1);
    });

    it('should return empty array when no users exist', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.data).toEqual([]);
      expect(body.pagination.total).toBe(0);
    });

    it('should exclude soft-deleted users', async () => {
      // Create and delete a user
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'deleted@example.com', name: 'Deleted User' },
      });
      const user = JSON.parse(createResponse.body);

      await app.inject({
        method: 'DELETE',
        url: `/users/${user.id}`,
        headers: { authorization: `Bearer ${authToken}` },
      });

      const response = await app.inject({
        method: 'GET',
        url: '/users',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.data).toHaveLength(0);
    });

    it('should return 401 when not authenticated', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/users',
      });

      expect(response.statusCode).toBe(401);
    });
  });

  describe('GET /users/:id', () => {
    it('should get user by ID', async () => {
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'getme@example.com', name: 'Get Me' },
      });
      const createdUser = JSON.parse(createResponse.body);

      const response = await app.inject({
        method: 'GET',
        url: `/users/${createdUser.id}`,
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.id).toBe(createdUser.id);
      expect(body.email).toBe('getme@example.com');
      expect(body.name).toBe('Get Me');
    });

    it('should return 404 when user not found', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/users/550e8400-e29b-41d4-a716-446655440000',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(404);
    });

    it('should return 404 for soft-deleted user', async () => {
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'todelete@example.com', name: 'To Delete' },
      });
      const user = JSON.parse(createResponse.body);

      await app.inject({
        method: 'DELETE',
        url: `/users/${user.id}`,
        headers: { authorization: `Bearer ${authToken}` },
      });

      const response = await app.inject({
        method: 'GET',
        url: `/users/${user.id}`,
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(404);
    });

    it('should return 400 for invalid UUID', async () => {
      const response = await app.inject({
        method: 'GET',
        url: '/users/not-a-uuid',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(400);
    });
  });

  describe('PUT /users/:id', () => {
    it('should update user name', async () => {
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'update@example.com', name: 'Old Name' },
      });
      const user = JSON.parse(createResponse.body);

      const response = await app.inject({
        method: 'PUT',
        url: `/users/${user.id}`,
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          name: 'New Name',
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.name).toBe('New Name');
      expect(body.email).toBe('update@example.com');
    });

    it('should update avatar URL', async () => {
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'avatar@example.com', name: 'Avatar User' },
      });
      const user = JSON.parse(createResponse.body);

      const response = await app.inject({
        method: 'PUT',
        url: `/users/${user.id}`,
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          avatarUrl: 'https://example.com/new-avatar.jpg',
        },
      });

      expect(response.statusCode).toBe(200);
      const body = JSON.parse(response.body);
      expect(body.avatarUrl).toBe('https://example.com/new-avatar.jpg');
    });

    it('should return 404 when user not found', async () => {
      const response = await app.inject({
        method: 'PUT',
        url: '/users/550e8400-e29b-41d4-a716-446655440000',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {
          name: 'New Name',
        },
      });

      expect(response.statusCode).toBe(404);
    });

    it('should return 400 when payload is empty', async () => {
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'test@example.com', name: 'Test User' },
      });
      const user = JSON.parse(createResponse.body);

      const response = await app.inject({
        method: 'PUT',
        url: `/users/${user.id}`,
        headers: {
          authorization: `Bearer ${authToken}`,
        },
        payload: {},
      });

      expect(response.statusCode).toBe(200); // Empty updates are technically valid
    });
  });

  describe('DELETE /users/:id', () => {
    it('should soft delete user', async () => {
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'delete@example.com', name: 'Delete Me' },
      });
      const user = JSON.parse(createResponse.body);

      const response = await app.inject({
        method: 'DELETE',
        url: `/users/${user.id}`,
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(204);
      expect(response.body).toBe('');

      // Verify user is soft deleted
      const getResponse = await app.inject({
        method: 'GET',
        url: `/users/${user.id}`,
        headers: { authorization: `Bearer ${authToken}` },
      });
      expect(getResponse.statusCode).toBe(404);
    });

    it('should return 404 when user not found', async () => {
      const response = await app.inject({
        method: 'DELETE',
        url: '/users/550e8400-e29b-41d4-a716-446655440000',
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(404);
    });

    it('should return 404 when deleting already deleted user', async () => {
      const createResponse = await app.inject({
        method: 'POST',
        url: '/users',
        headers: { authorization: `Bearer ${authToken}` },
        payload: { email: 'double-delete@example.com', name: 'Double Delete' },
      });
      const user = JSON.parse(createResponse.body);

      await app.inject({
        method: 'DELETE',
        url: `/users/${user.id}`,
        headers: { authorization: `Bearer ${authToken}` },
      });

      const response = await app.inject({
        method: 'DELETE',
        url: `/users/${user.id}`,
        headers: {
          authorization: `Bearer ${authToken}`,
        },
      });

      expect(response.statusCode).toBe(404);
    });
  });
});
