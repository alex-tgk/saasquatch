import fp from 'fastify-plugin';
import knex, { Knex } from 'knex';

declare module 'fastify' {
  interface FastifyInstance {
    db: Knex;
  }
}

export interface DatabaseService {
  getUserByEmail(email: string, tenantId?: string): Promise<any>;
  getUserById(id: string, tenantId?: string): Promise<any>;
  createUser(userData: { email: string; password: string; tenantId?: string }): Promise<any>;
  updateUserLastLogin(id: string, tenantId?: string): Promise<void>;
}

async function databasePlugin(fastify: any) {
  const config: Knex.Config = {
    client: '{{infrastructure.database.type}}',
    connection: {{#if (eq infrastructure.database.type "postgresql")}}process.env.DATABASE_URL || {
      host: process.env.DB_HOST || 'localhost',
      port: parseInt(process.env.DB_PORT || '5432', 10),
      user: process.env.DB_USER || 'postgres',
      password: process.env.DB_PASSWORD || 'postgres',
      database: process.env.DB_NAME || '{{snakeCase service.name}}',
    }{{else}}process.env.DATABASE_URL || './data/{{service.name}}.db'{{/if}},{{#if (eq infrastructure.database.type "sqlite")}}
    useNullAsDefault: true,{{/if}}
    pool: {
      min: 2,
      max: 10,
    },
    migrations: {
      directory: './migrations',
      tableName: 'knex_migrations',
    },
    debug: process.env.NODE_ENV === 'development',
  };

  const db = knex(config);

  // Test connection
  try {
    await db.raw('SELECT 1{{#if (eq infrastructure.database.type "postgresql")}}+1{{/if}}');
    fastify.log.info('Database connected successfully');
  } catch (error) {
    fastify.log.error('Database connection failed:', error);
    throw error;
  }

  // Database service for auth-specific operations
  const databaseService: DatabaseService = {
    async getUserByEmail(email: string, tenantId?: string) {
      {{#if infrastructure.database.multiTenancy}}if (!tenantId) {
        throw new Error('Tenant ID is required for multi-tenant database');
      }

      // Set schema for tenant
      await db.raw('SET search_path TO ??', [`tenant_${tenantId}`]);
      {{/if}}

      const user = await db('users')
        .where({ email })
        .first();

      return user;
    },

    async getUserById(id: string, tenantId?: string) {
      {{#if infrastructure.database.multiTenancy}}if (!tenantId) {
        throw new Error('Tenant ID is required for multi-tenant database');
      }

      // Set schema for tenant
      await db.raw('SET search_path TO ??', [`tenant_${tenantId}`]);
      {{/if}}

      const user = await db('users')
        .where({ id })
        .first();

      return user;
    },

    async createUser(userData: { email: string; password: string; tenantId?: string }) {
      {{#if infrastructure.database.multiTenancy}}if (!userData.tenantId) {
        throw new Error('Tenant ID is required for multi-tenant database');
      }

      // Set schema for tenant
      await db.raw('SET search_path TO ??', [`tenant_${userData.tenantId}`]);
      {{/if}}

      const [user] = await db('users')
        .insert({
          email: userData.email,
          password: userData.password,
          created_at: db.fn.now(),
          updated_at: db.fn.now(),
        })
        .returning('*');

      return user;
    },

    async updateUserLastLogin(id: string, tenantId?: string) {
      {{#if infrastructure.database.multiTenancy}}if (!tenantId) {
        throw new Error('Tenant ID is required for multi-tenant database');
      }

      // Set schema for tenant
      await db.raw('SET search_path TO ??', [`tenant_${tenantId}`]);
      {{/if}}

      await db('users')
        .where({ id })
        .update({
          last_login: db.fn.now(),
          updated_at: db.fn.now(),
        });
    },
  };

  // Decorate Fastify instance
  fastify.decorate('db', db);
  fastify.decorate('databaseService', databaseService);

  // Cleanup on shutdown
  fastify.addHook('onClose', async () => {
    fastify.log.info('Closing database connection');
    await db.destroy();
  });

  fastify.log.info('Database plugin registered');
}

export default fp(databasePlugin, {
  name: 'database',
});

export { databasePlugin };
